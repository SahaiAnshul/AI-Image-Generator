<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <!-- Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to top, #c471ed, #f6f4f2, #12c4b7);
            background-attachment: fixed;
            background-size: cover;
        }
        .image-card {
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.8s ease-in-out;
        }
        .image-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 0.5rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .image-card:hover .image-card-overlay {
            transform: translateY(0);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-bounce-once {
            animation: bounce 0.6s ease-in-out;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-8">
        
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Your Creative Canvas with AI âœ¨</h1>
            <p class="text-gray-500 mt-2">Generate stunning visuals, get inspired, and manage your creations all in one place!</p>
        </div>

        <!-- Input Section -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <input type="text" id="promptInput" placeholder="A futuristic city at sunset..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
            <select id="imageCount" class="p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1">1 Image</option>
                <option value="2">2 Images</option>
                <option value="3">3 Images</option>
                <option value="4">4 Images</option>
            </select>
            <button id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                Generate
            </button>
            <button id="surpriseBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                Surprise Me! ðŸŽ‰
            </button>
        </div>

        <!-- New AI Feature Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="analyzeImageBtn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500">
                Analyze Image âœ¨
            </button>
        </div>

        <!-- Results Display Section -->
        <div id="resultsContainer" class="space-y-4">
            <!-- Image Analysis Display -->
            <div id="imageAnalysisContainer" class="hidden">
                <h3 class="font-bold text-lg mb-2">Image Analysis:</h3>
                <div id="imageAnalysisText" class="p-4 bg-gray-100 rounded-xl border border-gray-300 text-gray-800"></div>
                <div id="analyzeLoading" class="hidden text-center text-gray-500 mt-2">
                    Analyzing...
                </div>
            </div>
        </div>

        <!-- Main Image Gallery -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Current Images</h2>
            <div id="currentImageGallery" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingContainer" class="hidden text-center mt-6">
            <div class="flex flex-col items-center justify-center text-gray-500">
                <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loadingText" class="mt-2 text-sm">Generating images...</span>
            </div>
        </div>
        
        <!-- Image History Gallery -->
        <div class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Gallery History</h2>
                <div class="flex gap-2">
                    <button id="clearHistoryBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-xl text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Clear History
                    </button>
                </div>
            </div>
            <div id="historyGallery" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM element references
            const promptInput = document.getElementById('promptInput');
            const imageCountSelect = document.getElementById('imageCount');
            const generateBtn = document.getElementById('generateBtn');
            const surpriseBtn = document.getElementById('surpriseBtn');
            const analyzeImageBtn = document.getElementById('analyzeImageBtn');
            const currentImageGallery = document.getElementById('currentImageGallery');
            const historyGallery = document.getElementById('historyGallery');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const loadingContainer = document.getElementById('loadingContainer');
            const messageBox = document.getElementById('messageBox');
            const imageAnalysisContainer = document.getElementById('imageAnalysisContainer');
            const imageAnalysisText = document.getElementById('imageAnalysisText');
            const analyzeLoading = document.getElementById('analyzeLoading');
            
            // API setup
            const apiKey = "";
            const imageGenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let currentRetry = 0;
            const maxRetries = 3;
            const retryDelayMs = 2000;
            let lastGeneratedImageBase64 = null;
            let userPromptHistory = []; // Array to store user's successful prompts

            const surprisePrompts = [
                "A cyberpunk cityscape at dawn with neon signs reflecting in puddles.",
                "An enchanted forest with glowing mushrooms and tiny fairies.",
                "A whimsical, floating island with a small cottage and a waterfall.",
                "A digital painting of a majestic dragon made of stars and galaxies.",
                "A fluffy cat wearing a tiny astronaut helmet, floating in space.",
                "A retro-futuristic robot bartender serving drinks in a vintage diner.",
                "An ancient library filled with books that glow softly.",
                "A serene Japanese garden with cherry blossoms and a small pond.",
                "An underwater city made of coral and shimmering glass.",
                "A friendly monster riding a bicycle through a field of flowers."
            ];

            // Utility function to show messages to the user
            function showMessage(text, isError = false) {
                if (messageBox) {
                    messageBox.innerHTML = `<div class="p-3 rounded-xl text-sm font-medium ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">${text}</div>`;
                    setTimeout(() => {
                        if (messageBox) {
                            messageBox.innerHTML = '';
                        }
                    }, 5000);
                }
            }

            // Function to generate the image elements and download button
            function createCard(base64Data, prompt) {
                const imageUrl = `data:image/png;base64,${base64Data}`;
                const card = document.createElement('div');
                card.className = "image-card bg-gray-200 rounded-xl overflow-hidden shadow-md flex justify-center items-center h-64";
                
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = prompt;
                img.className = "w-full h-full object-cover";
                
                const overlay = document.createElement('div');
                overlay.className = "image-card-overlay";
                
                const downloadBtn = document.createElement('button');
                downloadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>';
                downloadBtn.title = "Download Image";
                downloadBtn.className = "p-2 rounded-full bg-blue-500 hover:bg-blue-600 transition-colors";
                downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = `gemini_image_${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v2.25A2.25 2.25 0 0113.5 21h-6A2.25 2.25 0 015.25 18.75V15M15.75 17.25H18A2.25 2.25 0 0020.25 15V7.5A2.25 2.25 0 0018 5.25H8.25A2.25 2.25 0 006 7.5V15M15.75 17.25L12 21M9 12h6M9 15h6M9 18h6" /></svg>';
                copyBtn.title = "Copy Image";
                copyBtn.className = "p-2 rounded-full bg-blue-500 hover:bg-blue-600 transition-colors";
                copyBtn.onclick = () => {
                    const img = card.querySelector('img');
                    if (img) {
                        const imageUrl = img.src;
                        // Create a temporary textarea element to hold the text
                        const tempTextarea = document.createElement('textarea');
                        tempTextarea.value = imageUrl;
                        document.body.appendChild(tempTextarea);
                        tempTextarea.select();
                        try {
                            document.execCommand('copy');
                            showMessage("Image data URL copied to clipboard!", false);
                        } catch (err) {
                            showMessage("Failed to copy image data. Please try downloading instead.", true);
                            console.error("Copy error:", err);
                        }
                        document.body.removeChild(tempTextarea);
                    }
                };
                overlay.appendChild(downloadBtn);
                overlay.appendChild(copyBtn);
                card.appendChild(img);
                card.appendChild(overlay);
                return card;
            }

            // Main API call function with exponential backoff
            async function callGeminiImageApi(prompt, sampleCount) {
                const payload = {
                    instances: { prompt: prompt },
                    parameters: { "sampleCount": sampleCount }
                };

                const fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                try {
                    const response = await fetch(imageGenApiUrl, fetchOptions);

                    if (response.status === 429 && currentRetry < maxRetries) {
                        currentRetry++;
                        const delay = retryDelayMs * Math.pow(2, currentRetry - 1);
                        showMessage(`Too many requests. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return await callGeminiImageApi(prompt, sampleCount);
                    }

                    if (!response.ok) {
                        // Check for JSON content-type before attempting to parse
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.includes("application/json")) {
                            const errorData = await response.json();
                            throw new Error(errorData.error.message || `API error: ${response.status}`);
                        } else {
                            const errorText = await response.text();
                            throw new Error(`API error: ${response.status} - ${errorText}`);
                        }
                    }

                    const result = await response.json();
                    return result.predictions;

                } catch (error) {
                    throw error;
                }
            }

            // Main generation handler
            async function generateImages(useSurprisePrompt = false) {
                let prompt = promptInput.value.trim();
                const sampleCount = parseInt(imageCountSelect.value, 10);
                
                console.log(`Requested sampleCount: ${sampleCount}`);

                if (useSurprisePrompt) {
                    if (userPromptHistory.length > 0) {
                        const randomIndex = Math.floor(Math.random() * userPromptHistory.length);
                        prompt = userPromptHistory[randomIndex];
                        promptInput.value = prompt;
                    } else {
                        const randomIndex = Math.floor(Math.random() * surprisePrompts.length);
                        prompt = surprisePrompts[randomIndex];
                        promptInput.value = prompt;
                    }
                }
                
                if (!prompt) {
                    showMessage("Please enter a prompt.", true);
                    return;
                }

                // Add the new prompt to history
                userPromptHistory.push(prompt);

                // Move current images to history before clearing
                while (currentImageGallery.firstChild) {
                    historyGallery.prepend(currentImageGallery.firstChild);
                }

                // Show loading state and disable buttons
                loadingContainer.classList.remove('hidden');
                generateBtn.disabled = true;
                surpriseBtn.disabled = true;
                analyzeImageBtn.disabled = true;
                
                if (messageBox) {
                    messageBox.innerHTML = '';
                }
                
                try {
                    const predictions = await callGeminiImageApi(prompt, sampleCount);
                    
                    if (predictions && predictions.length > 0) {
                        const imagesToDisplay = predictions.slice(0, sampleCount);
                        currentImageGallery.innerHTML = '';

                        imagesToDisplay.forEach((prediction, index) => {
                            if (prediction.bytesBase64Encoded) {
                                const card = createCard(prediction.bytesBase64Encoded, prompt);
                                currentImageGallery.appendChild(card);
                                if (index === 0) {
                                    lastGeneratedImageBase64 = prediction.bytesBase64Encoded;
                                }
                            }
                        });
                        showMessage(`Generated ${imagesToDisplay.length} image(s) successfully!`);
                    } else {
                        throw new Error("No image data received from the API.");
                    }
                } catch (error) {
                    console.error("Error during image generation:", error);
                    showMessage(`Error: ${error.message}`, true);
                } finally {
                    // Reset UI state
                    loadingContainer.classList.add('hidden');
                    generateBtn.disabled = false;
                    surpriseBtn.disabled = false;
                    analyzeImageBtn.disabled = false;
                    currentRetry = 0; // Reset retry counter
                }
            }
            
            // Function to analyze the most recent image using Gemini
            async function analyzeImage() {
                if (!lastGeneratedImageBase64) {
                    showMessage("Please generate an image first.", true);
                    return;
                }

                analyzeImageBtn.disabled = true;
                analyzeLoading.classList.remove('hidden');
                imageAnalysisContainer.classList.remove('hidden');
                imageAnalysisText.textContent = '';

                const llmPrompt = "Describe this image in detail.";

                try {
                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: llmPrompt },
                                    {
                                        inlineData: {
                                            mimeType: "image/png",
                                            data: lastGeneratedImageBase64
                                        }
                                    }
                                ]
                            }
                        ]
                    };

                    const response = await fetch(textApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} - ${errorData.error.message}`);
                    }
                    
                    const result = await response.json();
                    const analysisText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (analysisText) {
                        imageAnalysisText.textContent = analysisText.trim();
                    } else {
                        throw new Error("Failed to get image analysis.");
                    }
                } catch (error) {
                    console.error('Error analyzing image:', error);
                    imageAnalysisText.textContent = `Error: ${error.message}`;
                } finally {
                    analyzeImageBtn.disabled = false;
                    analyzeLoading.classList.add('hidden');
                }
            }

            // Event listeners
            generateBtn.addEventListener('click', () => generateImages());
            surpriseBtn.addEventListener('click', () => {
                surpriseBtn.classList.add('animate-bounce-once');
                surpriseBtn.addEventListener('animationend', () => {
                    surpriseBtn.classList.remove('animate-bounce-once');
                }, { once: true });
                generateImages(true);
            });
            analyzeImageBtn.addEventListener('click', analyzeImage);
            clearHistoryBtn.addEventListener('click', () => {
                historyGallery.innerHTML = '';
            });

            promptInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    generateImages();
                }
            });
        });
    </script>
</body>
</html>
